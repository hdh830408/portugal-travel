<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a0a00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>í¬ë¥´íˆ¬ê°ˆ ì—¬í–‰</title>
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
    :root{
      --bg:#0d0600;
      --bg2:#160b00;
      --card:#1e1000;
      --card2:#261500;
      --border:#3a2000;
      --accent:#e8a84a;
      --accent2:#c97320;
      --gold:#f5c842;
      --text:#f0e6d3;
      --muted:#9a8070;
      --green:#4ecb7a;
      --red:#e85050;
      --blue:#4a9eff;
      --teal:#2ec4a0;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden;font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text)}
    #app{height:100vh;display:flex;flex-direction:column;overflow:hidden}

    /* â”€â”€ HEADER â”€â”€ */
    .header{
      background:linear-gradient(135deg,#1a0a00,#2d1200);
      padding:12px 16px 10px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;
      flex-shrink:0;
    }
    .header h1{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold);letter-spacing:1px}
    .header .dates{font-size:10px;color:var(--muted);margin-top:1px}
    .header-right{display:flex;gap:8px;align-items:center}
    .ai-badge{
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:#1a0a00;font-size:10px;font-weight:700;
      padding:4px 10px;border-radius:20px;
      cursor:pointer;transition:transform .15s;
      border:none;font-family:inherit;
    }
    .ai-badge:active{transform:scale(.95)}
    .settings-btn{
      background:var(--card);border:1px solid var(--border);
      color:var(--muted);font-size:14px;
      width:30px;height:30px;border-radius:50%;
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all .2s;
    }
    .settings-btn.active{border-color:var(--accent);color:var(--accent)}

    /* Settings panel */
    .settings-panel{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.85);z-index:4000;
      display:none;align-items:center;justify-content:center;padding:20px;
    }
    .settings-panel.open{display:flex}
    .settings-card{
      background:var(--bg2);border-radius:20px;border:2px solid var(--accent);
      padding:24px;width:100%;max-width:360px;
      box-shadow:0 8px 40px rgba(0,0,0,.6);
    }
    .settings-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold);margin-bottom:6px}
    .settings-label{font-size:11px;color:var(--accent);font-weight:700;margin-bottom:6px;letter-spacing:.5px}
    .settings-input{
      width:100%;background:var(--card);border:1px solid var(--border);
      color:var(--text);padding:12px;border-radius:10px;
      font-size:13px;margin-bottom:12px;outline:none;
      font-family:inherit;box-sizing:border-box;
    }
    .settings-input:focus{border-color:var(--accent)}
    .settings-link{
      display:flex;align-items:center;gap:6px;
      color:var(--blue);font-size:12px;text-decoration:none;margin-bottom:16px;
    }
    .settings-status{
      display:flex;align-items:center;gap:6px;
      font-size:12px;padding:8px 12px;border-radius:8px;margin-bottom:12px;
    }
    .status-ok{background:rgba(78,203,122,.1);color:var(--green)}
    .status-none{background:rgba(154,128,112,.1);color:var(--muted)}
    .settings-actions{display:flex;gap:10px;margin-top:4px}
    .btn-cancel{
      flex:1;padding:11px;border-radius:10px;border:1px solid var(--border);
      background:none;color:var(--muted);font-size:13px;cursor:pointer;font-family:inherit;
    }
    .btn-save{
      flex:2;padding:11px;border-radius:10px;border:none;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:#1a0a00;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;
    }
    .btn-clear{
      flex:1;padding:11px;border-radius:10px;border:1px solid var(--red);
      background:none;color:var(--red);font-size:12px;cursor:pointer;font-family:inherit;
    }
    .provider-tabs{display:flex;gap:6px;margin-bottom:12px}
    .provider-tab{
      flex:1;padding:8px 4px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);color:var(--muted);font-size:11px;font-weight:700;
      cursor:pointer;text-align:center;transition:all .2s;font-family:inherit;
    }
    .provider-tab.active{background:var(--card2);border-color:var(--accent);color:var(--accent)}
    .model-list{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .model-option{
      padding:10px 12px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);cursor:pointer;transition:all .2s;
    }
    .model-option.selected{border-color:var(--accent);background:rgba(232,168,74,.08)}
    .model-option-name{font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px}
    .model-option-desc{font-size:10px;color:var(--muted);line-height:1.4}
    .model-option-badge{
      display:inline-block;font-size:9px;font-weight:700;
      padding:1px 6px;border-radius:10px;margin-bottom:4px;
    }
    .badge-free{background:rgba(78,203,122,.15);color:var(--green)}
    .badge-paid{background:rgba(74,158,255,.15);color:var(--blue)}
    .badge-cheap{background:rgba(232,168,74,.15);color:var(--accent)}
    .api-section-title{font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.5px;margin-bottom:6px}

    /* â”€â”€ TABS â”€â”€ */
    .tabs{
      display:flex;background:var(--bg2);
      border-bottom:1px solid var(--border);
      flex-shrink:0;overflow-x:auto;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      flex:1;min-width:70px;padding:10px 4px;text-align:center;
      font-size:11px;color:var(--muted);cursor:pointer;
      border-bottom:2px solid transparent;transition:all .2s;
      white-space:nowrap;
    }
    .tab.active{color:var(--accent);border-color:var(--accent)}
    .tab .tab-icon{font-size:16px;display:block;margin-bottom:2px}

    /* â”€â”€ MAIN CONTENT â”€â”€ */
    .content{flex:1;overflow-y:auto;overflow-x:hidden}
    .content::-webkit-scrollbar{width:3px}
    .content::-webkit-scrollbar-thumb{background:var(--border)}
    .page{display:none;padding:12px}
    .page.active{display:block}

    /* â”€â”€ DAY SELECTOR â”€â”€ */
    .day-pills{
      display:flex;gap:6px;overflow-x:auto;
      padding-bottom:8px;margin-bottom:12px;
    }
    .day-pills::-webkit-scrollbar{display:none}
    .day-pill{
      flex-shrink:0;padding:6px 14px;border-radius:20px;
      border:1px solid var(--border);font-size:12px;
      cursor:pointer;transition:all .2s;color:var(--muted);
      white-space:nowrap;background:var(--card);
    }
    .day-pill.active{background:var(--accent);color:#1a0a00;font-weight:700;border-color:var(--accent)}

    /* â”€â”€ CATEGORY FILTER â”€â”€ */
    .cat-filter{display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:12px}
    .cat-filter::-webkit-scrollbar{display:none}
    .cat-btn{
      flex-shrink:0;padding:5px 12px;border-radius:16px;
      border:1px solid var(--border);font-size:11px;
      cursor:pointer;color:var(--muted);background:var(--card);
      white-space:nowrap;transition:all .2s;
    }
    .cat-btn.active{background:var(--card2);color:var(--text);border-color:var(--accent)}

    /* â”€â”€ SEARCH â”€â”€ */
    .search-bar{display:flex;gap:8px;margin-bottom:12px}
    .search-input{
      flex:1;background:var(--card);border:1px solid var(--border);
      color:var(--text);padding:10px 14px;border-radius:10px;
      font-size:13px;font-family:inherit;outline:none;
      transition:border-color .2s;
    }
    .search-input:focus{border-color:var(--accent)}
    .search-input::placeholder{color:var(--muted)}

    /* â”€â”€ PLACE CARD â”€â”€ */
    .place-card{
      background:var(--card);border:1px solid var(--border);
      border-radius:12px;padding:12px 14px;margin-bottom:8px;
      cursor:pointer;transition:all .2s;position:relative;
    }
    .place-card:active{transform:scale(.99);border-color:var(--accent)}
    .place-card.bookmarked{border-color:var(--gold)}
    .place-header{display:flex;align-items:flex-start;gap:10px}
    .place-rank{
      min-width:26px;height:26px;background:var(--accent2);
      color:#fff;border-radius:8px;display:flex;align-items:center;
      justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;
    }
    .place-info{flex:1;min-width:0}
    .place-name{font-size:14px;font-weight:700;color:var(--text);margin-bottom:2px}
    .place-badges{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px}
    .badge{font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600}
    .badge-rating{background:rgba(248,193,67,.15);color:var(--gold)}
    .badge-price{background:rgba(78,203,122,.1);color:var(--green)}
    .badge-hours{background:rgba(74,158,255,.1);color:var(--blue)}
    .badge-type{background:rgba(58,32,0,.8);color:var(--accent);border:1px solid var(--border)}
    .place-addr{font-size:11px;color:var(--muted);margin-bottom:4px}
    .place-desc{font-size:12px;color:var(--text);opacity:.85;line-height:1.5}
    .place-landmarks{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px;margin-bottom:4px}
    .landmark-tag{
      font-size:10px;padding:3px 8px;border-radius:12px;
      background:rgba(46,196,160,.12);color:var(--teal);border:1px solid rgba(46,196,160,.3);
      cursor:pointer;transition:all .2s;white-space:nowrap;
    }
    .landmark-tag:active{background:rgba(46,196,160,.25);transform:scale(.97)}
    .place-actions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
    .place-btn{
      flex:1;min-width:calc(20% - 4px);padding:7px 6px;border-radius:8px;font-size:11px;font-weight:600;
      border:none;cursor:pointer;font-family:inherit;transition:all .2s;white-space:nowrap;
    }
    .btn-map{background:rgba(74,158,255,.15);color:var(--blue)}
    .btn-search{background:rgba(130,130,130,.15);color:var(--muted)}
    .btn-review{background:rgba(255,180,50,.15);color:#ffb432}
    .btn-kr{background:rgba(255,100,100,.15);color:#ff6b6b}
    .btn-save{background:rgba(248,193,67,.12);color:var(--gold)}
    .btn-save.saved{background:rgba(248,193,67,.3);color:var(--gold)}
    .place-btn:active{transform:scale(.97)}

    /* â”€â”€ ITINERARY â”€â”€ */
    .day-card-full{
      background:var(--card);border:1px solid var(--border);
      border-radius:14px;margin-bottom:12px;overflow:hidden;
    }
    .day-card-header{
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      padding:12px 16px;cursor:pointer;
      display:flex;justify-content:space-between;align-items:center;
    }
    .day-card-header .dc-num{font-family:'Playfair Display',serif;font-size:22px;color:#1a0a00;font-weight:900}
    .day-card-header .dc-title{font-size:13px;color:#2a1000;font-weight:600;flex:1;margin:0 10px;line-height:1.3}
    .day-card-header .dc-chevron{color:#2a1000;font-size:16px;transition:transform .3s}
    .day-card-header.open .dc-chevron{transform:rotate(180deg)}
    .day-card-body{display:none;padding:14px 16px}
    .day-card-body.open{display:block}
    .schedule-item{
      display:flex;gap:10px;padding:7px 0;
      border-bottom:1px solid var(--border);
    }
    .schedule-item:last-child{border-bottom:none}
    .sched-time{font-size:11px;color:var(--accent);font-weight:700;min-width:44px;flex-shrink:0;padding-top:1px}
    .sched-activity{font-size:12px;line-height:1.5;flex:1}
    .tip-box{
      background:rgba(248,193,67,.06);border-left:3px solid var(--accent);
      border-radius:0 8px 8px 0;padding:8px 12px;margin:8px 0;
      font-size:12px;line-height:1.5;color:var(--text);opacity:.85;
    }

    /* â”€â”€ SAVED â”€â”€ */
    .empty-state{
      text-align:center;padding:60px 20px;
      color:var(--muted);font-size:14px;
    }
    .empty-state .icon{font-size:48px;margin-bottom:12px}

    /* â”€â”€ AI CHAT â”€â”€ */
    .ai-panel{
      position:fixed;bottom:0;left:0;right:0;
      background:var(--bg2);border-top:2px solid var(--accent);
      border-radius:20px 20px 0 0;
      transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
      z-index:1000;max-height:75vh;display:flex;flex-direction:column;
      box-shadow:0 -8px 40px rgba(0,0,0,.6);
    }
    .ai-panel.open{transform:translateY(0)}
    .ai-panel-header{
      padding:14px 20px 10px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
    }
    .ai-panel-title{font-size:15px;font-weight:700;color:var(--accent)}
    .ai-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:4px}
    .ai-messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
    .ai-messages::-webkit-scrollbar{width:2px}
    .ai-messages::-webkit-scrollbar-thumb{background:var(--border)}
    .msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.6}
    .msg-user{
      align-self:flex-end;background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:#1a0a00;font-weight:500;border-radius:14px 14px 4px 14px;
    }
    .msg-ai{
      align-self:flex-start;background:var(--card2);color:var(--text);
      border:1px solid var(--border);border-radius:14px 14px 14px 4px;
    }
    .msg-ai.loading{color:var(--muted)}
    .ai-input-row{
      padding:10px 12px 20px;border-top:1px solid var(--border);
      display:flex;gap:8px;flex-shrink:0;
    }
    .ai-input{
      flex:1;background:var(--card);border:1px solid var(--border);
      color:var(--text);padding:10px 14px;border-radius:22px;
      font-size:13px;font-family:inherit;outline:none;
    }
    .ai-input:focus{border-color:var(--accent)}
    .ai-send{
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:#1a0a00;border:none;border-radius:22px;
      padding:10px 18px;font-weight:700;font-size:13px;
      cursor:pointer;font-family:inherit;flex-shrink:0;
    }
    .ai-send:disabled{opacity:.5}
    .ai-suggestions{
      display:flex;gap:6px;overflow-x:auto;padding:8px 12px 4px;
      border-bottom:1px solid var(--border);
    }
    .ai-suggestions::-webkit-scrollbar{display:none}
    .ai-sug{
      flex-shrink:0;padding:5px 12px;border-radius:14px;
      background:var(--card);border:1px solid var(--border);
      font-size:11px;color:var(--muted);cursor:pointer;white-space:nowrap;
      transition:all .2s;
    }
    .ai-sug:active{background:var(--card2);color:var(--text)}

    /* â”€â”€ MODAL â”€â”€ */
    .modal{
      position:fixed;inset:0;z-index:2000;
      background:rgba(0,0,0,.8);
      display:none;align-items:flex-end;
    }
    .modal.open{display:flex}
    .modal-card{
      background:var(--bg2);border-top:2px solid var(--accent);
      border-radius:20px 20px 0 0;padding:20px 16px 32px;
      width:100%;max-height:70vh;overflow-y:auto;
    }
    .modal-name{font-family:'Playfair Display',serif;font-size:22px;color:var(--gold);margin-bottom:6px}
    .modal-close{float:right;background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;margin:-4px -4px 0 0}

    /* â”€â”€ TOAST â”€â”€ */
    .toast{
      position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);
      background:var(--card2);border:1px solid var(--border);
      color:var(--text);padding:10px 20px;border-radius:20px;
      font-size:13px;font-weight:500;opacity:0;transition:all .3s;
      pointer-events:none;white-space:nowrap;z-index:3000;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* â”€â”€ LANDMARK TAG POPUP â”€â”€ */
    .tag-popup-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.7);
      z-index:2500;display:none;align-items:center;justify-content:center;
    }
    .tag-popup-overlay.open{display:flex}
    .tag-popup{
      background:var(--bg2);border:2px solid var(--teal);
      border-radius:16px;padding:16px;min-width:200px;max-width:280px;
      box-shadow:0 8px 32px rgba(0,0,0,.5);
    }
    .tag-popup-title{
      font-size:14px;font-weight:700;color:var(--teal);
      margin-bottom:12px;display:flex;align-items:center;gap:6px;
    }
    .tag-popup-btn{
      width:100%;padding:12px;margin-bottom:8px;border-radius:10px;
      border:1px solid var(--border);background:var(--card);
      color:var(--text);font-size:13px;font-weight:500;
      cursor:pointer;font-family:inherit;transition:all .2s;
      display:flex;align-items:center;gap:8px;
    }
    .tag-popup-btn:last-child{margin-bottom:0}
    .tag-popup-btn:active{background:var(--card2);transform:scale(.98)}
    .tag-popup-btn-icon{font-size:16px}

    /* â”€â”€ LANDMARK FILTER BAR â”€â”€ */
    .landmark-filter-bar{
      display:none;align-items:center;gap:8px;
      background:rgba(46,196,160,.1);border:1px solid rgba(46,196,160,.3);
      border-radius:10px;padding:8px 12px;margin-bottom:12px;
    }
    .landmark-filter-bar.active{display:flex}
    .landmark-filter-text{
      flex:1;font-size:12px;color:var(--teal);font-weight:500;
      display:flex;align-items:center;gap:6px;
    }
    .landmark-filter-close{
      background:none;border:none;color:var(--teal);
      font-size:18px;cursor:pointer;padding:0 4px;
    }

    /* â”€â”€ ROUTE PAGE â”€â”€ */
    .route-day-selector{
      display:flex;gap:10px;padding:12px 16px;background:var(--bg2);
      border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;
      overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;
    }
    .route-day-selector::-webkit-scrollbar{height:3px}
    .route-day-selector::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}
    .route-day-selector::-webkit-scrollbar-track{background:transparent}
    .route-day-btn{
      flex-shrink:0;padding:12px 20px;border-radius:12px;border:1px solid var(--border);
      background:var(--card);color:var(--muted);font-size:14px;font-weight:600;
      cursor:pointer;transition:all .2s;font-family:inherit;white-space:nowrap;
    }
    .route-day-btn.active{
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:#1a0a00;border-color:var(--accent);
    }
    .route-container{padding:16px;}
    .route-section{
      background:var(--card);border:1px solid var(--border);
      border-radius:16px;padding:16px;margin-bottom:12px;
    }
    .route-section-header{
      display:flex;align-items:center;gap:10px;margin-bottom:12px;
    }
    .route-section-icon{
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      display:flex;align-items:center;justify-content:center;font-size:18px;
    }
    .route-section-title{
      font-size:14px;font-weight:700;color:var(--gold);
    }
    .route-section-time{
      font-size:11px;color:var(--muted);margin-top:2px;
    }
    .route-places{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    }
    .route-place{
      background:var(--bg2);border:1px solid var(--border);
      padding:6px 12px;border-radius:20px;font-size:12px;color:var(--text);
      cursor:pointer;transition:all .2s;
    }
    .route-place:hover{border-color:var(--accent);color:var(--accent);}
    .route-place.highlight{
      background:linear-gradient(135deg,rgba(232,168,74,.2),rgba(201,115,32,.2));
      border-color:var(--accent);color:var(--gold);
    }
    .route-arrow{
      color:var(--accent);font-size:14px;margin:0 2px;
    }
    .route-connector{
      display:flex;justify-content:center;padding:8px 0;
    }
    .route-connector-arrow{
      width:40px;height:40px;border-radius:50%;
      background:var(--card2);border:2px solid var(--accent);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;color:var(--accent);
    }
    .route-summary{
      background:linear-gradient(135deg,rgba(232,168,74,.1),rgba(201,115,32,.05));
      border:1px solid var(--accent);border-radius:12px;
      padding:14px;margin-top:16px;
    }
    .route-summary-title{
      font-size:13px;font-weight:700;color:var(--gold);margin-bottom:8px;
    }
    .route-summary-text{
      font-size:12px;color:var(--text);line-height:1.6;
    }
    .route-tip{
      display:flex;align-items:flex-start;gap:8px;
      background:rgba(78,203,122,.1);border-radius:8px;
      padding:10px 12px;margin-top:12px;
    }
    .route-tip-icon{font-size:14px;}
    .route-tip-text{font-size:11px;color:var(--green);line-height:1.5;}

    /* â”€â”€ DATA EDITOR HINT â”€â”€ */
    .data-hint{
      background:rgba(74,158,255,.1);border:1px dashed var(--blue);
      border-radius:10px;padding:12px;margin-bottom:12px;
      font-size:11px;color:var(--blue);line-height:1.5;
    }
    .data-hint code{background:rgba(0,0,0,.3);padding:2px 6px;border-radius:4px}

    /* â”€â”€ GUIDE MODAL (í•´ì„¤ íŒì—…) â”€â”€ */
    .guide-modal{
      position:fixed;inset:0;z-index:3000;
      background:rgba(0,0,0,.9);
      display:none;align-items:flex-end;
      -webkit-overflow-scrolling:touch;
    }
    .guide-modal.open{display:flex}
    .guide-card{
      background:var(--bg);
      border-top:3px solid var(--gold);
      border-radius:24px 24px 0 0;
      width:100%;max-height:85vh;
      overflow-y:auto;
      animation:guideSlideUp .3s ease-out;
    }
    @keyframes guideSlideUp{
      from{transform:translateY(100%)}
      to{transform:translateY(0)}
    }
    .guide-header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(135deg,#1a0a00,#2d1200);
      padding:16px 20px;
      border-bottom:1px solid var(--border);
    }
    .guide-header-top{
      display:flex;justify-content:space-between;align-items:flex-start;
    }
    .guide-emoji{font-size:32px;margin-right:12px;}
    .guide-title{font-family:'Playfair Display',serif;font-size:22px;color:var(--gold);flex:1}
    .guide-close{
      background:var(--card);border:1px solid var(--border);
      color:var(--muted);font-size:18px;width:36px;height:36px;
      border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all .2s;flex-shrink:0;
    }
    .guide-close:active{background:var(--card2);color:var(--text)}
    .guide-subtitle{
      font-size:13px;color:var(--accent);margin-top:6px;line-height:1.4;
    }
    .guide-content{padding:0 16px 32px;}
    .guide-section{
      background:var(--card);border:1px solid var(--border);
      border-radius:16px;padding:16px;margin-top:16px;
    }
    .guide-section-title{
      display:flex;align-items:center;gap:8px;
      font-size:14px;font-weight:700;color:var(--gold);margin-bottom:12px;
    }
    .guide-section-icon{font-size:18px;}
    .guide-history{
      font-size:13px;line-height:1.7;color:var(--text);
    }
    .guide-photo-list{display:flex;flex-direction:column;gap:8px;}
    .guide-photo-item{
      display:flex;align-items:flex-start;gap:10px;
      font-size:12px;color:var(--text);line-height:1.5;
    }
    .guide-photo-icon{color:var(--accent);font-size:14px;flex-shrink:0;}
    .guide-tips-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .guide-tip-box{
      background:var(--bg2);border-radius:10px;padding:10px;
      text-align:center;
    }
    .guide-tip-label{font-size:10px;color:var(--muted);margin-bottom:4px;font-weight:600}
    .guide-tip-value{font-size:13px;color:var(--text);font-weight:500}
    .guide-tip-note{
      grid-column:1/-1;
      background:rgba(232,168,74,.1);border:1px solid rgba(232,168,74,.3);
      border-radius:10px;padding:12px;
      font-size:12px;color:var(--accent);line-height:1.5;margin-top:4px;
    }
    .guide-food-list{display:flex;flex-direction:column;gap:8px;}
    .guide-food-item{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--bg2);border-radius:10px;padding:10px 12px;
      cursor:pointer;transition:all .2s;
    }
    .guide-food-item:active{background:var(--card2)}
    .guide-food-name{font-size:13px;color:var(--text);font-weight:500}
    .guide-food-meta{display:flex;gap:6px;align-items:center;}
    .guide-food-rating{font-size:11px;color:var(--gold)}
    .guide-food-price{font-size:11px;color:var(--muted)}
    .guide-food-arrow{color:var(--accent);font-size:14px;}
    .guide-actions{
      display:flex;gap:10px;margin-top:16px;padding:0 16px 16px;
    }
    .guide-btn{
      flex:1;padding:10px 6px;border-radius:12px;
      font-size:11px;font-weight:600;cursor:pointer;
      font-family:inherit;transition:all .2s;white-space:nowrap;
    }
    .guide-btn-map{
      background:rgba(74,158,255,.15);border:1px solid rgba(74,158,255,.3);color:var(--blue);
    }
    .guide-btn-search{
      background:rgba(130,130,130,.15);border:1px solid rgba(130,130,130,.3);color:var(--muted);
    }
    .guide-btn-review{
      background:rgba(255,180,50,.15);border:1px solid rgba(255,180,50,.3);color:#ffb432;
    }
    .guide-btn-kr{
      background:rgba(255,100,100,.15);border:1px solid rgba(255,100,100,.3);color:#ff6b6b;
    }
    .guide-btn-save{
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      border:none;color:#1a0a00;
    }
    .guide-btn-save.saved{
      background:var(--card);border:1px solid var(--gold);color:var(--gold);
    }
    .guide-no-data{
      text-align:center;padding:40px 20px;
      color:var(--muted);font-size:13px;
    }
    .guide-no-data-icon{font-size:40px;margin-bottom:12px;opacity:.5}

    /* â•â•â• í’ë¶€í•œ ê´€ê´‘ì§€ ìƒì„¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ â•â•â• */
    .modal-header-rich{
      display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;
    }
    .modal-icon{
      width:48px;height:48px;border-radius:12px;
      background:linear-gradient(135deg,var(--card2),var(--card));
      border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-size:24px;flex-shrink:0;
    }
    .modal-title-area{flex:1}
    .modal-name{
      font-family:'Playfair Display',serif;font-size:18px;
      color:var(--gold);font-weight:700;margin-bottom:4px;
    }
    .modal-subtitle{
      font-size:12px;color:var(--muted);line-height:1.4;
    }
    .modal-section{
      background:var(--card);border:1px solid var(--border);
      border-radius:12px;padding:14px;margin-bottom:12px;
    }
    .section-title{
      font-size:13px;font-weight:700;color:var(--accent);
      margin-bottom:10px;display:flex;align-items:center;gap:6px;
    }
    .section-content{
      font-size:13px;line-height:1.7;color:var(--text);
    }
    .section-list{display:flex;flex-direction:column;gap:6px}
    .spot-item{
      font-size:12px;color:var(--text);
      padding:6px 10px;background:var(--bg2);border-radius:8px;
      display:flex;align-items:center;gap:6px;
    }
    .visit-info-grid{
      display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;
    }
    .visit-info-item{
      text-align:center;padding:10px 8px;
      background:var(--bg2);border-radius:8px;
    }
    .visit-label{font-size:10px;color:var(--muted);margin-bottom:4px}
    .visit-value{font-size:13px;font-weight:600;color:var(--text)}
    .tip-box{
      background:rgba(232,168,74,.1);border:1px solid rgba(232,168,74,.2);
      border-radius:8px;padding:10px 12px;
      font-size:12px;color:var(--accent);line-height:1.5;
    }
    .nearby-note{
      font-size:11px;color:var(--muted);margin-bottom:8px;
    }
    .nearby-foods-list{
      display:flex;flex-direction:column;gap:6px;margin-bottom:10px;
    }
    .nearby-food-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;background:var(--bg2);border-radius:8px;
      cursor:pointer;transition:all .2s;
    }
    .nearby-food-item:hover{background:var(--card2);border-color:var(--accent)}
    .food-name{font-size:13px;color:var(--text)}
    .food-meta{font-size:11px;color:var(--muted)}
    .btn-nearby-all{
      width:100%;padding:12px;border-radius:10px;border:1px solid rgba(46,196,160,.3);
      background:rgba(46,196,160,.1);color:var(--teal);
      font-size:13px;font-weight:600;cursor:pointer;
      transition:all .2s;font-family:inherit;
    }
    .btn-nearby-all:hover{background:rgba(46,196,160,.2)}
    .modal-actions{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;
    }

    /* ğŸ–¥ï¸ PC/íƒœë¸”ë¦¿ ëŒ€ì‘: ëª¨ë°”ì¼ ì•±ì²˜ëŸ¼ ì¤‘ì•™ ì •ë ¬ */
    @media (min-width: 500px) {
      body { background-color: #111; display: flex; justify-content: center; min-height: 100vh; }
      #app { width: 100%; max-width: 420px; background-color: var(--bg); box-shadow: 0 0 40px rgba(0,0,0,0.5); position: relative; }
      
      /* ê³ ì • ìš”ì†Œë“¤ë„ ì•± ë„ˆë¹„ì— ë§ê²Œ ì¡°ì • */
      .settings-panel, .modal, .guide-modal, .tag-popup-overlay { 
        left: 50%; width: 420px; margin-left: -210px; 
      }
      .ai-panel { 
        left: 50%; width: 420px; margin-left: -210px; right: auto;
      }
    }
    </style>
</head>
<body>
<div id="app">
  <!-- HEADER -->
  <div class="header">
    <div>
      <h1 id="appTitle">ğŸ‡µğŸ‡¹ Portugal 2026</h1>
      <div class="dates" id="appDates">May 1â€“10 Â· 9ë°•10ì¼ ì—¬í–‰ ê°€ì´ë“œ (v9)</div>
    </div>
    <div class="header-right">
      <button class="ai-badge" onclick="toggleAI()">âœ¨ AI Agent</button>
      <button class="settings-btn" onclick="toggleSettings()" id="settingsBtn">âš™ï¸</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('food')">
      <span class="tab-icon">ğŸ½ï¸</span>ë§›ì§‘
    </div>
    <div class="tab" onclick="switchTab('landmark')">
      <span class="tab-icon">ğŸ›ï¸</span>ê´€ê´‘ì§€
    </div>
    <div class="tab" onclick="switchTab('schedule')">
      <span class="tab-icon">ğŸ“…</span>ì¼ì •
    </div>
    <div class="tab" onclick="switchTab('route')">
      <span class="tab-icon">ğŸ—ºï¸</span>ë™ì„ 
    </div>
    <div class="tab" onclick="switchTab('saved')">
      <span class="tab-icon">â­</span>ì €ì¥ë¨
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <!-- FOOD PAGE -->
    <div id="page-food" class="page active">
      <div class="search-bar">
        <input class="search-input" placeholder="ğŸ” ì‹ë‹¹ ì´ë¦„, ì£¼ì†Œ ê²€ìƒ‰..." 
               oninput="onSearch(this.value)" id="searchInput">
      </div>
      <div class="landmark-filter-bar" id="landmarkFilterBar">
        <span class="landmark-filter-text">ğŸ“ <span id="landmarkFilterName"></span> ê·¼ì²˜ ë§›ì§‘</span>
        <button class="landmark-filter-close" onclick="clearLandmarkFilter()">âœ•</button>
      </div>
      <div class="day-pills" id="dayPills"></div>
      <div class="cat-filter" id="catFilter"></div>
      <div id="placeList"></div>
    </div>

    <!-- LANDMARK PAGE -->
    <div id="page-landmark" class="page">
      <div class="search-bar">
        <input class="search-input" placeholder="ğŸ” ê´€ê´‘ì§€ ì´ë¦„, ì£¼ì†Œ ê²€ìƒ‰..." 
               oninput="onLandmarkSearch(this.value)" id="landmarkSearchInput">
      </div>
      <div class="day-pills" id="landmarkDayPills"></div>
      <div class="cat-filter" id="landmarkCatFilter"></div>
      <div id="landmarkList"></div>
    </div>

    <!-- SCHEDULE PAGE -->
    <div id="page-schedule" class="page">
      <div id="scheduleList"></div>
    </div>

    <!-- ROUTE PAGE -->
    <div id="page-route" class="page">
      <div class="route-day-selector">
        <button class="route-day-btn" onclick="selectRouteDay('DAY 2')">DAY 2</button>
        <button class="route-day-btn" onclick="selectRouteDay('DAY 3')">DAY 3</button>
        <button class="route-day-btn" onclick="selectRouteDay('DAY 4')">DAY 4</button>
        <button class="route-day-btn" onclick="selectRouteDay('DAY 5')">DAY 5</button>
        <button class="route-day-btn" onclick="selectRouteDay('DAY 6')">DAY 6</button>
        <button class="route-day-btn active" onclick="selectRouteDay('DAY 7')">DAY 7</button>
        <button class="route-day-btn" onclick="selectRouteDay('DAY 8')">DAY 8</button>
        <button class="route-day-btn" onclick="selectRouteDay('DAY 9')">DAY 9</button>
      </div>
      <div id="routeContent"></div>
    </div>

    <!-- SAVED PAGE -->
    <div id="page-saved" class="page">
      <div id="savedList"></div>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-panel" id="settingsPanel" onclick="if(event.target===this)toggleSettings()">
  <div class="settings-card" style="max-height:85vh;overflow-y:auto">
    <div class="settings-title">âš™ï¸ AI ì„¤ì •</div>
    
    <div id="apiStatus"></div>

    <!-- Provider íƒ­ -->
    <div class="api-section-title">AI ì œê³µì ì„ íƒ</div>
    <div class="provider-tabs">
      <button class="provider-tab" id="tab-openrouter" onclick="switchProvider('openrouter')">
        ğŸ”€ OpenRouter<br><span style="font-size:9px;font-weight:400">í¬ë ˆë”§í•„ìš”</span>
      </button>
      <button class="provider-tab active" id="tab-google" onclick="switchProvider('google')">
        ğŸ†“ Google<br><span style="font-size:9px;font-weight:400">ì™„ì „ë¬´ë£Œ</span>
      </button>
      <button class="provider-tab" id="tab-anthropic" onclick="switchProvider('anthropic')">
        ğŸ¤– Claude<br><span style="font-size:9px;font-weight:400">ìœ ë£Œ</span>
      </button>
    </div>

    <!-- OpenRouter ì„¹ì…˜ -->
    <div id="section-openrouter" style="display:none">
      <div class="api-section-title">ë¬´ë£Œ ëª¨ë¸ ì„ íƒ</div>
      <div class="model-list" id="modelList">
        <div class="model-option selected" onclick="selectModel('openrouter/free',this)">
          <span class="model-option-badge badge-free" style="background:rgba(167,139,250,.15);color:#a78bfa">ğŸ”€ ìë™</span>
          <div class="model-option-name">Free Router â­ ì¶”ì²œ</div>
          <div class="model-option-desc">ê°€ìš©í•œ ë¬´ë£Œ ëª¨ë¸ ìë™ ì„ íƒ Â· ê°€ì¥ ì•ˆì •ì </div>
        </div>
        <div class="model-option" onclick="selectModel('meta-llama/llama-4-scout:free',this)">
          <span class="model-option-badge badge-free">ğŸ†“ ë¬´ë£Œ</span>
          <div class="model-option-name">Llama 4 Scout</div>
          <div class="model-option-desc">Meta ìµœì‹  Â· ë¹ ë¥´ê³  ì•ˆì •ì </div>
        </div>
        <div class="model-option" onclick="selectModel('qwen/qwen3-235b-a22b:free',this)">
          <span class="model-option-badge badge-free">ğŸ†“ ë¬´ë£Œ</span>
          <div class="model-option-name">Qwen3 235B</div>
          <div class="model-option-desc">ì•Œë¦¬ë°”ë°” ìµœì‹  Â· ê³ ì„±ëŠ¥ MoE</div>
        </div>
        <div class="model-option" onclick="selectModel('moonshotai/kimi-vl-a3b-thinking:free',this)">
          <span class="model-option-badge badge-free">ğŸ†“ ë¬´ë£Œ</span>
          <div class="model-option-name">Kimi VL Thinking</div>
          <div class="model-option-desc">ì¶”ë¡  ê°•í™” ëª¨ë¸ Â· ë³µì¡í•œ ì§ˆë¬¸ì— ì¢‹ìŒ</div>
        </div>
        <div class="model-option" onclick="selectModel('nousresearch/deephermes-3-llama-3-8b-preview:free',this)">
          <span class="model-option-badge badge-free">ğŸ†“ ë¬´ë£Œ</span>
          <div class="model-option-name">DeepHermes 3</div>
          <div class="model-option-desc">ê°€ë²¼ìš´ 8B ëª¨ë¸ Â· ë¹ ë¥¸ ì‘ë‹µ</div>
        </div>
      </div>

      <div class="api-section-title">OPENROUTER API KEY</div>
      <input class="settings-input" id="apiKeyInput" type="password"
        placeholder="sk-or-v1-..."
        autocomplete="off" autocorrect="off" autocapitalize="none">
      <a class="settings-link" href="https://openrouter.ai/keys" target="_blank">
        ğŸ”— openrouter.ai/keys ì—ì„œ ë¬´ë£Œ ë°œê¸‰ (ì‹ ìš©ì¹´ë“œ ë¶ˆí•„ìš”)
      </a>
    </div>

    <!-- Google AI Studio ì„¹ì…˜ -->
    <div id="section-google">
      <div class="model-list">
        <div class="model-option selected" onclick="selectModel('gemini-2.0-flash',this)">
          <span class="model-option-badge badge-free">ğŸ†“ ì™„ì „ë¬´ë£Œ</span>
          <div class="model-option-name">Gemini 2.0 Flash â­ ì¶”ì²œ</div>
          <div class="model-option-desc">Google ìµœì‹  Â· v1 API ì™„ì „ ì§€ì› Â· ê°€ì¥ ì•ˆì •ì </div>
        </div>
        <div class="model-option" onclick="selectModel('gemini-2.0-flash-lite',this)">
          <span class="model-option-badge badge-free">ğŸ†“ ì™„ì „ë¬´ë£Œ</span>
          <div class="model-option-name">Gemini 2.0 Flash Lite</div>
          <div class="model-option-desc">ë” ê°€ë³ê³  ë¹ ë¦„ Â· ì¿¼í„° ì—¬ìœ ë¡œì›€</div>
        </div>
      </div>
      <div class="api-section-title">GOOGLE AI STUDIO API KEY</div>
      <input class="settings-input" id="apiKeyInputGoogle" type="password"
        placeholder="AIzaSy..."
        autocomplete="off" autocorrect="off" autocapitalize="none">
      <a class="settings-link" href="https://aistudio.google.com/apikey" target="_blank">
        ğŸ”— aistudio.google.com/apikey ì—ì„œ ë¬´ë£Œ ë°œê¸‰ (ì¹´ë“œ ë¶ˆí•„ìš”)
      </a>
    </div>

    <!-- Anthropic ì„¹ì…˜ -->
    <div id="section-anthropic" style="display:none">
      <div class="model-list">
        <div class="model-option selected" onclick="selectModel('claude-sonnet-4-20250514',this)">
          <span class="model-option-badge badge-paid">ğŸ’³ ìœ ë£Œ</span>
          <div class="model-option-name">Claude Sonnet 4</div>
          <div class="model-option-desc">ê°€ì¥ ê· í˜•ì¡íŒ ì„±ëŠ¥ Â· í•œêµ­ì–´ ìµœê³  í’ˆì§ˆ</div>
        </div>
        <div class="model-option" onclick="selectModel('claude-haiku-4-5-20251001',this)">
          <span class="model-option-badge badge-paid">ğŸ’³ ìœ ë£Œ (ì €ë ´)</span>
          <div class="model-option-name">Claude Haiku 4.5</div>
          <div class="model-option-desc">ë¹ ë¥´ê³  ì €ë ´ Â· ê°„ë‹¨í•œ ì¶”ì²œì— ì í•©</div>
        </div>
      </div>
      <div class="api-section-title">ANTHROPIC API KEY</div>
      <input class="settings-input" id="apiKeyInputAnthropic" type="password"
        placeholder="sk-ant-api03-..."
        autocomplete="off" autocorrect="off" autocapitalize="none">
      <a class="settings-link" href="https://console.anthropic.com" target="_blank">
        ğŸ”— console.anthropic.com ì—ì„œ ë°œê¸‰
      </a>
    </div>

    <div class="api-section-title" style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">ì•± ë°ì´í„° ê´€ë¦¬</div>
    <button class="btn-nearby-all" onclick="hardRefresh()" style="margin-bottom:16px;background:rgba(232,168,74,.1);color:var(--accent);border-color:var(--accent)">
      ğŸ”„ ìºì‹œ ì‚­ì œ ë° ìµœì‹  ë²„ì „ ë°›ê¸°
    </button>

    <div class="settings-actions">
      <button class="btn-cancel" onclick="toggleSettings()">ë‹«ê¸°</button>
      <button class="btn-clear" onclick="clearApiKey()">ì´ˆê¸°í™”</button>
      <button class="btn-save" id="btnSave" onclick="saveApiKey()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- AI PANEL -->
<div class="ai-panel" id="aiPanel">
  <div class="ai-panel-header">
    <span class="ai-panel-title">âœ¨ í¬ë¥´íˆ¬ê°ˆ ì—¬í–‰ AI</span>
    <button class="ai-close" onclick="toggleAI()">Ã—</button>
  </div>
  <div class="ai-suggestions">
    <div class="ai-sug" onclick="askSuggestion('ì˜¤ëŠ˜ ì €ë… í•´ì‚°ë¬¼ ì¶”ì²œí•´ì¤˜')">ğŸ¦ í•´ì‚°ë¬¼ ì¶”ì²œ</div>
    <div class="ai-sug" onclick="askSuggestion('ê°€ì„±ë¹„ ì¢‹ì€ ë§›ì§‘ ì•Œë ¤ì¤˜')">ğŸ’° ê°€ì„±ë¹„ ë§›ì§‘</div>
    <div class="ai-sug" onclick="askSuggestion('ë¦¬ìŠ¤ë³¸ ë¸ŒëŸ°ì¹˜ ì–´ë””ê°€ ì¢‹ì•„?')">â˜• ë¸ŒëŸ°ì¹˜ ì¶”ì²œ</div>
  </div>
  <div class="ai-messages" id="aiMessages">
    <div class="msg msg-ai">ì•ˆë…•í•˜ì„¸ìš”! í¬ë¥´íˆ¬ê°ˆ ì—¬í–‰ ë„ìš°ë¯¸ì˜ˆìš” ğŸ‡µğŸ‡¹<br>ë§›ì§‘, ì¼ì •, ê¿€íŒ ë­ë“  ë¬¼ì–´ë³´ì„¸ìš”!</div>
  </div>
  <div class="ai-input-row">
    <input class="ai-input" id="aiInput" placeholder="ì—¬í–‰ì— ëŒ€í•´ ë­ë“  ë¬¼ì–´ë³´ì„¸ìš”..." 
           onkeydown="if(event.key==='Enter')sendAI()">
    <button class="ai-send" id="aiSend" onclick="sendAI()">ì „ì†¡</button>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="placeModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-card" id="modalCard">
    <button class="modal-close" onclick="closeModal()">Ã—</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- GUIDE MODAL (ì¥ì†Œ í•´ì„¤ íŒì—…) -->
<div class="guide-modal" id="guideModal" onclick="if(event.target===this)closeGuide()">
  <div class="guide-card">
    <div class="guide-header">
      <div class="guide-header-top">
        <span class="guide-emoji" id="guideEmoji">ğŸ“</span>
        <div class="guide-title" id="guideTitle">ì¥ì†Œëª…</div>
        <button class="guide-close" onclick="closeGuide()">âœ•</button>
      </div>
      <div class="guide-subtitle" id="guideSubtitle">ì¥ì†Œ ì„¤ëª…</div>
    </div>
    <div class="guide-content" id="guideContent">
      <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LANDMARK TAG POPUP -->
<div class="tag-popup-overlay" id="tagPopupOverlay" onclick="if(event.target===this)closeTagPopup()">
  <div class="tag-popup">
    <div class="tag-popup-title">ğŸ“ <span id="tagPopupName"></span></div>
    <button class="tag-popup-btn" onclick="filterByLandmark()">
      <span class="tag-popup-btn-icon">ğŸ”</span> ê·¼ì²˜ ë§›ì§‘ ë³´ê¸°
    </button>
    <button class="tag-popup-btn" onclick="openLandmarkMap()">
      <span class="tag-popup-btn-icon">ğŸ—ºï¸</span> ì§€ë„ì—ì„œ ë³´ê¸°
    </button>
    <button class="tag-popup-btn" onclick="openLandmarkGuide()">
      <span class="tag-popup-btn-icon">â„¹ï¸</span> ì¥ì†Œ ì •ë³´
    </button>
  </div>
</div>


    <script src="portugal_data.js"></script>
    <script src="portugal_guides.js"></script>
    <script src="coords_data.js"></script>

    <script>



    // ë§›ì§‘/ê´€ê´‘ì§€ íƒ€ì… ë¶„ë¦¬
    const FOOD_TYPES = ['cafe', 'dessert', 'seafood', 'restaurant', 'budget'];
    const LANDMARK_TYPES = ['landmark', 'church', 'viewpoint', 'square', 'transport'];

    let currentTab = 'food';
    let selectedDay = 'all';
    let selectedCat = 'all';
    let searchQuery = '';
    let savedPlaces = new Set(JSON.parse(localStorage.getItem('pt_saved') || '[]'));
    let aiOpen = false, isAILoading = false;
    let currentProvider = localStorage.getItem('pt_provider') || 'google';
    let currentModel = localStorage.getItem('pt_model') || 'gemini-2.0-flash';
    let selectedRouteDay = 'DAY 7';

    // ê´€ê´‘ì§€ íƒ­ìš© ìƒíƒœ ë³€ìˆ˜
    let selectedLandmarkDay = 'all';
    let selectedLandmarkCat = 'all';
    let landmarkSearchQuery = '';

    // ëœë“œë§ˆí¬ íƒœê·¸ í•„í„°ìš© ë³€ìˆ˜
    let selectedNearbyLandmark = null;
    let currentTagLandmark = null;

    // NEARBY_LANDMARKS ì—­ë§¤í•‘: ëœë“œë§ˆí¬ â†’ ë§›ì§‘ ëª©ë¡
    function getLandmarkToFoods() {
      const mapping = {};
      Object.entries(NEARBY_LANDMARKS).forEach(([food, landmarks]) => {
        landmarks.forEach(lm => {
          if (!mapping[lm]) mapping[lm] = [];
          if (!mapping[lm].includes(food)) mapping[lm].push(food);
        });
      });
      return mapping;
    }

    // Haversine ê³µì‹ìœ¼ë¡œ ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000; // ì§€êµ¬ ë°˜ê²½ (ë¯¸í„°)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // GPS ê¸°ë°˜ 500m ë°˜ê²½ ë‚´ ë§›ì§‘ ì°¾ê¸° (ê¸°ì¡´ 200m -> 500m í™•ì¥)
    function getNearbyFoodsByGPS(landmarkName, radiusMeters = 500) {
      const landmarkCoords = typeof PLACE_COORDS !== 'undefined' ? PLACE_COORDS[landmarkName] : null;
      if (!landmarkCoords) return [];
      
      const nearbyFoods = [];
      PLACES.forEach(p => {
        if (!FOOD_TYPES.includes(p.type)) return;
        const foodCoords = PLACE_COORDS[p.name];
        if (!foodCoords) return;
        
        const distance = getDistance(landmarkCoords.lat, landmarkCoords.lng, foodCoords.lat, foodCoords.lng);
        if (distance <= radiusMeters) {
          nearbyFoods.push({ name: p.name, distance: Math.round(distance) });
        }
      });
      
      // ê±°ë¦¬ìˆœ ì •ë ¬
      return nearbyFoods.sort((a, b) => a.distance - b.distance);
    }

    // íŠ¹ì • ëœë“œë§ˆí¬ ê·¼ì²˜ ë§›ì§‘ì´ ìˆëŠ”ì§€ í™•ì¸ (í•˜ì´ë¸Œë¦¬ë“œ: GPS 500m + ê¸°ì¡´ ë§¤í•‘)
    function hasNearbyFoods(landmarkName) {
      // 1. GPS ì¢Œí‘œê°€ ìˆìœ¼ë©´ 500m ë°˜ê²½ìœ¼ë¡œ í™•ì¸
      if (typeof PLACE_COORDS !== 'undefined' && PLACE_COORDS[landmarkName]) {
        const nearby = getNearbyFoodsByGPS(landmarkName, 500);
        if (nearby.length > 0) return true;
      }
      // 2. GPSì— ì—†ê±°ë‚˜ 500m ë‚´ ë§›ì§‘ ì—†ìœ¼ë©´ ê¸°ì¡´ ë§¤í•‘ ì‚¬ìš©
      const mapping = getLandmarkToFoods();
      return mapping[landmarkName] && mapping[landmarkName].length > 0;
    }

    // ë°ì´í„° ë³€í™˜: PLACES â†’ ë‚ ì§œë³„ êµ¬ì¡°
    function buildAppData() {
      const dayMap = {};
      ITINERARY.forEach(d => {
        dayMap[d.day] = { dayNum: d.day, title: `${d.date} â€” ${d.title.split('â€”')[1]?.trim() || d.title}`, categories: {} };
      });
      
      PLACES.forEach((place, idx) => {
        place.days.forEach(dayKey => {
          if (!dayMap[dayKey]) return;
          const cat = TYPE_LABELS[place.type] || 'ğŸ´ ê¸°íƒ€';
          if (!dayMap[dayKey].categories[cat]) dayMap[dayKey].categories[cat] = [];
          dayMap[dayKey].categories[cat].push({
            ...place,
            rank: dayMap[dayKey].categories[cat].length + 1,
            day: dayKey,
            category: cat,
            meta: `â˜… ${place.rating}${place.price}${place.hours}`
          });
        });
      });
      
      const foodByDay = Object.values(dayMap).map(d => ({
        ...d,
        categories: Object.entries(d.categories).map(([cat, places]) => ({ category: cat, places }))
      }));
      
      const allPlaces = PLACES.flatMap((place, idx) => 
        place.days.map(dayKey => ({
          ...place,
          day: dayKey,
          category: TYPE_LABELS[place.type],
          rank: idx + 1,
          meta: `â˜… ${place.rating}${place.price}${place.hours}`
        }))
      );
      
      const itinerary = ITINERARY.map((d, i) => ({
        id: i + 1,
        dayLabel: d.day + d.date.split(' ')[0],
        title: d.title,
        schedule: d.schedule,
        tips: d.tips,
        transport: d.transport
      }));
      
      return { foodByDay, allPlaces, itinerary };
    }

    const APP_DATA = buildAppData();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function init() {
      // APP_CONFIG ì ìš©
      if (typeof APP_CONFIG !== 'undefined') {
        document.title = `${APP_CONFIG.flag} ${APP_CONFIG.title}`;
        document.getElementById('appTitle').textContent = `${APP_CONFIG.flag} ${APP_CONFIG.title}`;
        document.getElementById('appDates').textContent = `${APP_CONFIG.dates} Â· ${APP_CONFIG.duration} ì—¬í–‰ ê°€ì´ë“œ`;
      }
      
      // ë§›ì§‘ íƒ­ ì´ˆê¸°í™”
      buildDayPills();
      buildCatFilter();
      renderFood();
      
      // ê´€ê´‘ì§€ íƒ­ ì´ˆê¸°í™”
      buildLandmarkDayFilter();
      buildLandmarkCatFilter();
      
      renderSchedule();
    }

    function buildDayPills() {
      const days = ['all', ...ITINERARY.map(d => d.day)];
      const labels = { all: 'ì „ì²´' };
      ITINERARY.forEach(d => labels[d.day] = d.day.replace('DAY ', 'Day'));
      document.getElementById('dayPills').innerHTML = days.map(d => 
        `<div class="day-pill ${d==='all'?'active':''}" onclick="selectDay('${d}')">${labels[d]}</div>`
      ).join('');
    }

    function buildCatFilter() {
      const cats = ['all', ...FOOD_TYPES];
      document.getElementById('catFilter').innerHTML = cats.map(c => 
        `<div class="cat-btn ${c==='all'?'active':''}" onclick="selectCat('${c}')">${c==='all' ? 'ì „ì²´' : TYPE_LABELS[c]}</div>`
      ).join('');
    }

    function selectDay(day) {
      selectedDay = day;
      document.querySelectorAll('#dayPills .day-pill').forEach(el => el.classList.toggle('active', el.textContent.includes(day === 'all' ? 'ì „ì²´' : day.replace('DAY ', 'Day'))));
      renderFood();
    }

    function selectCat(cat) {
      selectedCat = cat;
      document.querySelectorAll('#catFilter .cat-btn').forEach((el, i) => el.classList.toggle('active', i === ['all', ...FOOD_TYPES].indexOf(cat)));
      renderFood();
    }

    function onSearch(val) {
      searchQuery = val.trim();
      renderFood();
    }

    function getFilteredPlaces() {
      let places = APP_DATA.allPlaces;
      
      // ëœë“œë§ˆí¬ í•„í„°ê°€ í™œì„±í™”ë˜ë©´ Day/Category í•„í„° ë¬´ì‹œ (ì „ì²´ì—ì„œ ê²€ìƒ‰)
      if (!selectedNearbyLandmark) {
        if (selectedDay !== 'all') places = places.filter(p => p.day === selectedDay);
        if (selectedCat !== 'all') places = places.filter(p => p.type === selectedCat);
      }
      
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        places = places.filter(p => p.name.toLowerCase().includes(q) || p.address.toLowerCase().includes(q) || p.description.toLowerCase().includes(q));
      }
      // ëœë“œë§ˆí¬ ê·¼ì²˜ í•„í„° (í•˜ì´ë¸Œë¦¬ë“œ: GPS 500m ìš°ì„  + ê¸°ì¡´ ë§¤í•‘ í´ë°±)
      if (selectedNearbyLandmark) {
        let nearbyNames = [];
        
        // 1. GPS ì¢Œí‘œê°€ ìˆìœ¼ë©´ 500m ë°˜ê²½ìœ¼ë¡œ í•„í„°ë§ ì‹œë„
        if (typeof PLACE_COORDS !== 'undefined' && PLACE_COORDS[selectedNearbyLandmark]) {
          const nearbyFoods = getNearbyFoodsByGPS(selectedNearbyLandmark, 500);
          nearbyNames = nearbyFoods.map(f => f.name);
        }
        
        // 2. GPSì— ì—†ê±°ë‚˜ 500m ë‚´ ë§›ì§‘ ì—†ìœ¼ë©´ ê¸°ì¡´ ë§¤í•‘ ì‚¬ìš©
        if (nearbyNames.length === 0) {
          const mapping = getLandmarkToFoods();
          nearbyNames = mapping[selectedNearbyLandmark] || [];
        }
        
        places = places.filter(p => nearbyNames.includes(p.name));
      }
      // ì¤‘ë³µ ì œê±° (ëœë“œë§ˆí¬ í•„í„° ì‹œì—ëŠ” ì´ë¦„ë§Œìœ¼ë¡œ, ê·¸ ì™¸ì—ëŠ” ì´ë¦„+ë‚ ì§œë¡œ)
      const seen = new Set();
      return places.filter(p => {
        const key = selectedNearbyLandmark ? p.name : (p.name + p.day);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    // ëœë“œë§ˆí¬ íƒœê·¸ HTML ìƒì„±
    function renderLandmarkTags(placeName) {
      const landmarks = NEARBY_LANDMARKS[placeName];
      if (!landmarks || landmarks.length === 0) return '';
      return `
        <div class="place-landmarks">
          ${landmarks.map(lm => `<span class="landmark-tag" onclick="event.stopPropagation();openTagPopup('${esc(lm).replace(/'/g, "\\'")}')">${esc(lm)}</span>`).join('')}
        </div>
      `;
    }

    // ê±°ë¦¬ ë°°ì§€ ìƒì„±
    function renderDistanceBadge(placeName) {
      if (!selectedNearbyLandmark) return '';
      if (typeof PLACE_COORDS === 'undefined' || !PLACE_COORDS[selectedNearbyLandmark] || !PLACE_COORDS[placeName]) return '';
      
      const landmarkCoords = PLACE_COORDS[selectedNearbyLandmark];
      const foodCoords = PLACE_COORDS[placeName];
      const distance = Math.round(getDistance(landmarkCoords.lat, landmarkCoords.lng, foodCoords.lat, foodCoords.lng));
      
      return `<span class="badge" style="background:rgba(46,196,160,.15);color:var(--teal)">ğŸ“ ${distance}m</span>`;
    }

    function renderFood() {
      const places = getFilteredPlaces().filter(p => FOOD_TYPES.includes(p.type));
      if (places.length === 0) {
        const emptyMsg = selectedNearbyLandmark 
          ? '<div class="empty-state"><div class="icon">ğŸ½ï¸</div>500m ì´ë‚´ì— ë§›ì§‘ì´ ì—†ì–´ìš”<br><small style="color:var(--muted)">í•„í„°ë¥¼ í•´ì œí•˜ê³  ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</small></div>'
          : '<div class="empty-state"><div class="icon">ğŸ½ï¸</div>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”</div>';
        document.getElementById('placeList').innerHTML = emptyMsg;
        return;
      }
      document.getElementById('placeList').innerHTML = places.map((p, i) => `
        <div class="place-card ${savedPlaces.has(p.name)?'bookmarked':''}" onclick="openModal(${PLACES.indexOf(p)})">
          <div class="place-header">
            <div class="place-rank">${i+1}</div>
            <div class="place-info">
              <div class="place-name">${esc(p.name)}</div>
              <div class="place-badges">
                <span class="badge badge-rating">â˜… ${p.rating}</span>
                <span class="badge badge-price">${p.price}</span>
                <span class="badge badge-hours">${p.hours}</span>
                <span class="badge badge-type">${TYPE_LABELS[p.type]||p.type}</span>
                ${renderDistanceBadge(p.name)}
              </div>
              ${renderLandmarkTags(p.name)}
              <div class="place-addr">ğŸ“ ${esc(p.address)}</div>
              <div class="place-desc">${esc(p.description)}</div>
            </div>
          </div>
          <div class="place-actions">
            <button class="place-btn btn-map" onclick="event.stopPropagation();openMap('${esc(p.searchName || p.name)}')">ğŸ“ ì§€ë„</button>
            <button class="place-btn btn-search" onclick="event.stopPropagation();openSearch('${esc(p.searchName || p.name)}')">ğŸ” ê²€ìƒ‰</button>
            <button class="place-btn btn-review" onclick="event.stopPropagation();openReview('${esc(p.searchName || p.name)}')">â­ ë¦¬ë·°</button>
            <button class="place-btn btn-kr" onclick="event.stopPropagation();openKrReview('${esc(p.searchName || p.name)}')">ğŸ‡°ğŸ‡·</button>
            <button class="place-btn btn-save ${savedPlaces.has(p.name)?'saved':''}" onclick="event.stopPropagation();toggleSave('${esc(p.name)}')">
              ${savedPlaces.has(p.name)?'â˜…':'â˜†'}
            </button>
          </div>
        </div>
      `).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ê´€ê´‘ì§€ íƒ­ í•¨ìˆ˜ë“¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getFilteredLandmarks() {
      let places = PLACES.filter(p => LANDMARK_TYPES.includes(p.type));
      
      if (selectedLandmarkDay !== 'all') {
        places = places.filter(p => p.days && p.days.includes(selectedLandmarkDay));
      }
      if (selectedLandmarkCat !== 'all') {
        places = places.filter(p => p.type === selectedLandmarkCat);
      }
      if (landmarkSearchQuery) {
        const q = landmarkSearchQuery.toLowerCase();
        places = places.filter(p => 
          p.name.toLowerCase().includes(q) || 
          p.address.toLowerCase().includes(q) || 
          p.description.toLowerCase().includes(q)
        );
      }
      return places;
    }

    function renderLandmark() {
      const places = getFilteredLandmarks();
      if (places.length === 0) {
        document.getElementById('landmarkList').innerHTML = '<div class="empty-state"><div class="icon">ğŸ›ï¸</div>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”</div>';
        return;
      }
      document.getElementById('landmarkList').innerHTML = places.map((p, i) => `
        <div class="place-card ${savedPlaces.has(p.name)?'bookmarked':''}" onclick="openModal(${PLACES.indexOf(p)})">
          <div class="place-header">
            <div class="place-rank">${i+1}</div>
            <div class="place-info">
              <div class="place-name">${esc(p.name)}</div>
              <div class="place-badges">
                <span class="badge badge-rating">â˜… ${p.rating}</span>
                <span class="badge badge-price">${p.price}</span>
                <span class="badge badge-hours">${p.hours}</span>
                <span class="badge badge-type">${TYPE_LABELS[p.type]||p.type}</span>
              </div>
              <div class="place-addr">ğŸ“ ${esc(p.address)}</div>
              <div class="place-desc">${esc(p.description)}</div>
            </div>
          </div>
          <div class="place-actions">
            <button class="place-btn btn-map" onclick="event.stopPropagation();openMap('${esc(p.searchName || p.name)}')">ğŸ“ ì§€ë„</button>
            <button class="place-btn btn-search" onclick="event.stopPropagation();openSearch('${esc(p.searchName || p.name)}')">ğŸ” ê²€ìƒ‰</button>
            <button class="place-btn btn-review" onclick="event.stopPropagation();openReview('${esc(p.searchName || p.name)}')">â­ ë¦¬ë·°</button>
            <button class="place-btn btn-kr" onclick="event.stopPropagation();openKrReview('${esc(p.searchName || p.name)}')">ğŸ‡°ğŸ‡·</button>
            <button class="place-btn btn-save ${savedPlaces.has(p.name)?'saved':''}" onclick="event.stopPropagation();toggleSave('${esc(p.name)}')">
              ${savedPlaces.has(p.name)?'â˜…':'â˜†'}
            </button>
          </div>
        </div>
      `).join('');
    }

    function buildLandmarkDayFilter() {
      const days = ['all', ...ITINERARY.map(d => d.day)];
      const labels = { all: 'ì „ì²´' };
      ITINERARY.forEach(d => labels[d.day] = d.day.replace('DAY ', 'Day'));
      document.getElementById('landmarkDayPills').innerHTML = days.map(d => 
        `<div class="day-pill ${d==='all'?'active':''}" onclick="selectLandmarkDay('${d}')">${labels[d]}</div>`
      ).join('');
    }

    function buildLandmarkCatFilter() {
      const cats = ['all', ...LANDMARK_TYPES];
      document.getElementById('landmarkCatFilter').innerHTML = cats.map(c => 
        `<div class="cat-btn ${c==='all'?'active':''}" onclick="selectLandmarkCat('${c}')">${c==='all' ? 'ì „ì²´' : TYPE_LABELS[c]}</div>`
      ).join('');
    }

    function selectLandmarkDay(day) {
      selectedLandmarkDay = day;
      document.querySelectorAll('#landmarkDayPills .day-pill').forEach(el => 
        el.classList.toggle('active', el.textContent.includes(day === 'all' ? 'ì „ì²´' : day.replace('DAY ', 'Day')))
      );
      renderLandmark();
    }

    function selectLandmarkCat(cat) {
      selectedLandmarkCat = cat;
      document.querySelectorAll('#landmarkCatFilter .cat-btn').forEach((el, i) => 
        el.classList.toggle('active', i === ['all', ...LANDMARK_TYPES].indexOf(cat))
      );
      renderLandmark();
    }

    function onLandmarkSearch(val) {
      landmarkSearchQuery = val.trim();
      renderLandmark();
    }

    function renderSchedule() {
      document.getElementById('scheduleList').innerHTML = APP_DATA.itinerary.map(d => `
        <div class="day-card-full">
          <div class="day-card-header" onclick="toggleDay(this)">
            <span class="dc-num">${d.dayLabel.substring(0,5)}</span>
            <span class="dc-title">${esc(d.title)}</span>
            <span class="dc-chevron">â–¼</span>
          </div>
          <div class="day-card-body">
            ${d.schedule.map(s => `
              <div class="schedule-item">
                <span class="sched-time">${s.time||''}</span>
                <span class="sched-activity">${esc(s.activity)}</span>
              </div>
            `).join('')}
            ${d.tips?.map(t => `<div class="tip-box">${esc(t)}</div>`).join('') || ''}
            <div style="font-size:11px;color:var(--muted);margin-top:8px">${esc(d.transport||'')}</div>
          </div>
        </div>
      `).join('');
    }

    function toggleDay(el) {
      el.classList.toggle('open');
      el.nextElementSibling.classList.toggle('open');
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', ['food','landmark','schedule','route','saved'][i] === tab));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + tab).classList.add('active');
      if (tab === 'landmark') renderLandmark();
      if (tab === 'saved') renderSaved();
      if (tab === 'route') renderRoute();
    }

    function selectRouteDay(day) {
      selectedRouteDay = day;
      document.querySelectorAll('.route-day-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === day);
      });
      renderRoute();
    }

    function renderRoute() {
      const data = ROUTES[selectedRouteDay];
      if (!data) return;
      
      let html = `<div class="route-container">`;
      html += `<div class="route-summary">
        <div class="route-summary-title">${data.title}</div>
        <div class="route-summary-text">${data.subtitle}</div>
      </div>`;
      
      data.sections.forEach((section, idx) => {
        html += `
          <div class="route-section">
            <div class="route-section-header">
              <div class="route-section-icon">${section.icon}</div>
              <div>
                <div class="route-section-title">${section.title}</div>
                <div class="route-section-time">${section.time}</div>
              </div>
            </div>
            <div class="route-places">
              ${section.places.map((place, i) => {
                const isHighlight = section.highlights?.includes(place);
                return `<span class="route-place ${isHighlight ? 'highlight' : ''}" onclick="showPlaceFromRoute('${place}')">${place}</span>` +
                  (i < section.places.length - 1 ? '<span class="route-arrow">â†’</span>' : '');
              }).join('')}
            </div>
          </div>
        `;
        
        if (idx < data.sections.length - 1) {
          html += `<div class="route-connector"><div class="route-connector-arrow">â¬‡ï¸</div></div>`;
        }
      });
      
      if (data.tips && data.tips.length > 0) {
        html += `<div style="margin-top:16px;">`;
        data.tips.forEach(tip => {
          html += `<div class="route-tip">
            <span class="route-tip-icon">ğŸ’¡</span>
            <span class="route-tip-text">${tip}</span>
          </div>`;
        });
        html += `</div>`;
      }
      
      html += `</div>`;
      document.getElementById('routeContent').innerHTML = html;
    }

    function showPlaceFromRoute(placeName) {
      // í•´ì„¤ ë°ì´í„° í™•ì¸
      if (typeof PLACE_GUIDES !== 'undefined' && PLACE_GUIDES[placeName]) {
        openGuide(placeName);
      } else {
        // í•´ì„¤ ë°ì´í„° ì—†ìœ¼ë©´ ê¸°ì¡´ ë§›ì§‘/ê´€ê´‘ì§€ ë°ì´í„°ì—ì„œ ì°¾ê¸°
        const place = PLACES.find(p => p.name === placeName);
        if (place) {
          showModal(place);
        } else {
          // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¸°ë³¸ í•´ì„¤ íŒì—… (ì •ë³´ ì—†ìŒ ìƒíƒœ)
          openGuide(placeName);
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í•´ì„¤ íŒì—… (GUIDE MODAL) í•¨ìˆ˜ë“¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openGuide(placeName) {
      const guide = typeof PLACE_GUIDES !== 'undefined' && PLACE_GUIDES[placeName] 
        ? PLACE_GUIDES[placeName] 
        : { 
            emoji: "ğŸ“", 
            subtitle: placeName,
            history: null,
            photoSpots: [],
            visitTips: null,
            nearbyFood: []
          };
      
      // í—¤ë” ì„¤ì •
      document.getElementById('guideEmoji').textContent = guide.emoji || 'ğŸ“';
      document.getElementById('guideTitle').textContent = placeName;
      document.getElementById('guideSubtitle').textContent = guide.subtitle || '';
      
      // ì½˜í…ì¸  ìƒì„±
      let html = '';
      
      // ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
      if (!guide.history && guide.photoSpots.length === 0 && !guide.visitTips && guide.nearbyFood.length === 0) {
        html = `
          <div class="guide-no-data">
            <div class="guide-no-data-icon">ğŸ“</div>
            <p>ì´ ì¥ì†Œì˜ ìƒì„¸ í•´ì„¤ì´ ì•„ì§ ì¤€ë¹„ ì¤‘ì´ì—ìš”.</p>
            <p style="margin-top:8px;font-size:11px;color:var(--muted)">ê³§ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤!</p>
          </div>
        `;
        
        // PLACES ë°ì´í„°ì— ìˆìœ¼ë©´ ê¸°ë³¸ ì •ë³´ë¼ë„ í‘œì‹œ
        const placeData = PLACES.find(p => p.name === placeName);
        if (placeData) {
          html += `
            <div class="guide-section">
              <div class="guide-section-title">
                <span class="guide-section-icon">â„¹ï¸</span>
                ê¸°ë³¸ ì •ë³´
              </div>
              <div class="guide-tips-grid">
                <div class="guide-tip-box">
                  <div class="guide-tip-label">í‰ì </div>
                  <div class="guide-tip-value">â˜… ${placeData.rating}</div>
                </div>
                <div class="guide-tip-box">
                  <div class="guide-tip-label">ê°€ê²©ëŒ€</div>
                  <div class="guide-tip-value">${placeData.price}</div>
                </div>
                <div class="guide-tip-box">
                  <div class="guide-tip-label">ìš´ì˜ì‹œê°„</div>
                  <div class="guide-tip-value">${placeData.hours}</div>
                </div>
                <div class="guide-tip-box">
                  <div class="guide-tip-label">ìœ í˜•</div>
                  <div class="guide-tip-value">${TYPE_LABELS[placeData.type] || placeData.type}</div>
                </div>
              </div>
              <div class="guide-tip-note">ğŸ“ ${placeData.address}</div>
              ${placeData.description ? `<div style="margin-top:12px;font-size:13px;color:var(--text);line-height:1.6">${placeData.description}</div>` : ''}
            </div>
          `;
        }
      } else {
        // ğŸ“œ ì—­ì‚¬ì  ë°°ê²½
        if (guide.history) {
          html += `
            <div class="guide-section">
              <div class="guide-section-title">
                <span class="guide-section-icon">ğŸ“œ</span>
                ì—­ì‚¬ì  ë°°ê²½
              </div>
              <div class="guide-history">${guide.history}</div>
            </div>
          `;
        }
        
        // ğŸ“¸ í¬í† ìŠ¤íŒŸ
        if (guide.photoSpots && guide.photoSpots.length > 0) {
          html += `
            <div class="guide-section">
              <div class="guide-section-title">
                <span class="guide-section-icon">ğŸ“¸</span>
                í¬í† ìŠ¤íŒŸ / ì´¬ì˜ íŒ
              </div>
              <div class="guide-photo-list">
                ${guide.photoSpots.map(spot => `
                  <div class="guide-photo-item">
                    <span class="guide-photo-icon">ğŸ“·</span>
                    <span>${spot}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        // ğŸ’¡ ë°©ë¬¸ íŒ
        if (guide.visitTips) {
          html += `
            <div class="guide-section">
              <div class="guide-section-title">
                <span class="guide-section-icon">ğŸ’¡</span>
                ë°©ë¬¸ íŒ
              </div>
              <div class="guide-tips-grid">
                <div class="guide-tip-box">
                  <div class="guide-tip-label">ìš´ì˜ì‹œê°„</div>
                  <div class="guide-tip-value">${guide.visitTips.hours || '-'}</div>
                </div>
                <div class="guide-tip-box">
                  <div class="guide-tip-label">ì…ì¥ë£Œ</div>
                  <div class="guide-tip-value">${guide.visitTips.fee || '-'}</div>
                </div>
                <div class="guide-tip-box">
                  <div class="guide-tip-label">ì†Œìš”ì‹œê°„</div>
                  <div class="guide-tip-value">${guide.visitTips.duration || '-'}</div>
                </div>
                ${guide.visitTips.tips ? `
                  <div class="guide-tip-note">ğŸ’¡ ${guide.visitTips.tips}</div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        // ğŸ½ï¸ ì£¼ë³€ ë§›ì§‘
        if (guide.nearbyFood && guide.nearbyFood.length > 0) {
          html += `
            <div class="guide-section">
              <div class="guide-section-title">
                <span class="guide-section-icon">ğŸ½ï¸</span>
                ì£¼ë³€ ë§›ì§‘
              </div>
              <div class="guide-food-list">
                ${guide.nearbyFood.map(foodName => {
                  const foodPlace = PLACES.find(p => p.name === foodName);
                  if (foodPlace) {
                    return `
                      <div class="guide-food-item" onclick="closeGuide();setTimeout(()=>showModal(PLACES.find(p=>p.name==='${foodName.replace(/'/g, "\\'")}'));,300)">
                        <span class="guide-food-name">${foodName}</span>
                        <div class="guide-food-meta">
                          <span class="guide-food-rating">â˜… ${foodPlace.rating}</span>
                          <span class="guide-food-price">${foodPlace.price}</span>
                          <span class="guide-food-arrow">â†’</span>
                        </div>
                      </div>
                    `;
                  }
                  return `
                    <div class="guide-food-item">
                      <span class="guide-food-name">${foodName}</span>
                      <div class="guide-food-meta">
                        <span class="guide-food-arrow">â†’</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }
      }
      
      document.getElementById('guideContent').innerHTML = html;
      
      // ê·¼ì²˜ ë§›ì§‘ ë²„íŠ¼ ì¶”ê°€ (í•´ë‹¹ ì¥ì†Œ ê·¼ì²˜ì— ë§›ì§‘ì´ ìˆëŠ” ê²½ìš°)
      if (hasNearbyFoods(placeName)) {
        const nearbyFoodBtn = `
          <div style="margin-top:16px;padding:0 16px;">
            <button class="guide-btn" style="width:100%;background:rgba(46,196,160,.15);border:1px solid rgba(46,196,160,.3);color:var(--teal);padding:12px;font-size:13px;" 
                    onclick="goToNearbyFood('${placeName.replace(/'/g, "\\'")}')">
              ğŸ½ï¸ ê·¼ì²˜ ë§›ì§‘ ë³´ê¸°
            </button>
          </div>
        `;
        document.getElementById('guideContent').innerHTML += nearbyFoodBtn;
      }
      
      // ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€ (ë§›ì§‘/ê´€ê´‘ì§€ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°)
      const placeData = PLACES.find(p => p.name === placeName);
      if (placeData) {
        const actionsHtml = `
          <div class="guide-actions">
            <button class="guide-btn guide-btn-map" onclick="openMap('${esc(placeData.searchName || placeData.name)}')">
              ğŸ“ ì§€ë„
            </button>
            <button class="guide-btn guide-btn-search" onclick="openSearch('${esc(placeData.searchName || placeData.name)}')">
              ğŸ” ê²€ìƒ‰
            </button>
            <button class="guide-btn guide-btn-review" onclick="openReview('${esc(placeData.searchName || placeData.name)}')">
              â­ ë¦¬ë·°
            </button>
            <button class="guide-btn guide-btn-kr" onclick="openKrReview('${esc(placeData.searchName || placeData.name)}')">
              ğŸ‡°ğŸ‡·
            </button>
            <button class="guide-btn guide-btn-save ${savedPlaces.has(placeName)?'saved':''}" 
                    onclick="toggleSaveFromGuide('${placeName.replace(/'/g, "\\'")}')">
              ${savedPlaces.has(placeName) ? 'â˜…' : 'â˜†'}
            </button>
          </div>
        `;
        document.getElementById('guideContent').innerHTML += actionsHtml;
      }
      
      // ëª¨ë‹¬ ì—´ê¸°
      document.getElementById('guideModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeGuide() {
      document.getElementById('guideModal').classList.remove('open');
      document.body.style.overflow = '';
    }

    function toggleSaveFromGuide(name) {
      toggleSave(name);
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      const btn = document.querySelector('.guide-btn-save');
      if (btn) {
        btn.classList.toggle('saved', savedPlaces.has(name));
        btn.innerHTML = savedPlaces.has(name) ? 'â˜… ì €ì¥ë¨' : 'â˜† ì €ì¥í•˜ê¸°';
      }
    }

    function renderSaved() {
      const saved = PLACES.filter(p => savedPlaces.has(p.name));
      if (saved.length === 0) {
        document.getElementById('savedList').innerHTML = '<div class="empty-state"><div class="icon">â­</div>ì €ì¥ëœ ë§›ì§‘ì´ ì—†ì–´ìš”<br>ë§›ì§‘ íƒ­ì—ì„œ â˜†ë¥¼ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”!</div>';
        return;
      }
      document.getElementById('savedList').innerHTML = saved.map((p, i) => `
        <div class="place-card bookmarked">
          <div class="place-header">
            <div class="place-rank">${i+1}</div>
            <div class="place-info">
              <div class="place-name">${esc(p.name)}</div>
              <div class="place-badges">
                <span class="badge badge-rating">â˜… ${p.rating}</span>
                <span class="badge badge-price">${p.price}</span>
                <span class="badge badge-type">${TYPE_LABELS[p.type]}</span>
              </div>
              <div class="place-addr">ğŸ“ ${esc(p.address)}</div>
            </div>
          </div>
          <div class="place-actions">
            <button class="place-btn btn-map" onclick="openMap('${esc(p.searchName || p.name)}')">ğŸ“ ì§€ë„</button>
            <button class="place-btn btn-search" onclick="openSearch('${esc(p.searchName || p.name)}')">ğŸ” ê²€ìƒ‰</button>
            <button class="place-btn btn-review" onclick="openReview('${esc(p.searchName || p.name)}')">â­ ë¦¬ë·°</button>
            <button class="place-btn btn-kr" onclick="openKrReview('${esc(p.searchName || p.name)}')">ğŸ‡°ğŸ‡·</button>
            <button class="place-btn btn-save saved" onclick="toggleSave('${esc(p.name)}');renderSaved()">âœ•</button>
          </div>
        </div>
      `).join('');
    }

    function toggleSave(name) {
      if (savedPlaces.has(name)) savedPlaces.delete(name);
      else savedPlaces.add(name);
      localStorage.setItem('pt_saved', JSON.stringify([...savedPlaces]));
      renderFood();
      showToast(savedPlaces.has(name) ? 'â­ ì €ì¥ë¨!' : 'ì €ì¥ í•´ì œ');
    }

    function openMap(searchNameOrAddr, placeName) {
      // searchNameì´ ìˆìœ¼ë©´ searchName ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ì£¼ì†Œ ì‚¬ìš©
      const query = searchNameOrAddr || placeName || '';
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
    }

    // ì¥ì†Œ ê°ì²´ë¡œ ì§€ë„ ì—´ê¸° (searchName ìš°ì„  ì‚¬ìš©)
    function openMapForPlace(place) {
      const query = place.searchName || place.name || place.address;
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
    }

    // êµ¬ê¸€ ê²€ìƒ‰ ì—´ê¸°
    function openSearch(searchNameOrAddr) {
      const query = searchNameOrAddr || '';
      window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
    }

    // êµ¬ê¸€ ë¦¬ë·° ê²€ìƒ‰ ì—´ê¸°
    function openReview(searchNameOrAddr) {
      const query = (searchNameOrAddr || '') + ' review';
      window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
    }

    // í•œêµ­ì–´ í›„ê¸° ê²€ìƒ‰ ì—´ê¸°
    function openKrReview(searchNameOrAddr) {
      const query = (searchNameOrAddr || '') + ' í›„ê¸° ë¸”ë¡œê·¸';
      window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
    }

    function openModal(idx) {
      // idxëŠ” ì „ì²´ PLACES ë°°ì—´ì˜ ì¸ë±ìŠ¤
      const p = PLACES[idx];
      showModal(p);
    }

    // place ê°ì²´ë¥¼ ì§ì ‘ ë°›ì•„ì„œ ëª¨ë‹¬ í‘œì‹œ
    function showModal(p) {
      if (!p) return;
      
      const isLandmark = LANDMARK_TYPES.includes(p.type);
      const detail = typeof LANDMARK_DETAILS !== 'undefined' ? LANDMARK_DETAILS[p.name] : null;
      
      // ê·¼ì²˜ ë§›ì§‘ ì°¾ê¸°
      const nearbyFoods = getNearbyFoodsList(p.name);
      
      let modalHtml = '';
      
      if (isLandmark && detail) {
        // â•â•â• í’ë¶€í•œ ê´€ê´‘ì§€ ìƒì„¸ ëª¨ë‹¬ â•â•â•
        modalHtml = `
          <div class="modal-header-rich">
            <div class="modal-icon">${detail.icon || 'ğŸ“'}</div>
            <div class="modal-title-area">
              <div class="modal-name">${esc(p.name)}</div>
              <div class="modal-subtitle">${esc(detail.subtitle || p.description)}</div>
            </div>
          </div>
          
          <div class="modal-section">
            <div class="section-title">ğŸ›ï¸ ì—­ì‚¬ì  ë°°ê²½</div>
            <div class="section-content">${esc(detail.history)}</div>
          </div>
          
          <div class="modal-section">
            <div class="section-title">ğŸ“¸ í¬í† ìŠ¤íŒŸ / ì´¬ì˜ íŒ</div>
            <div class="section-list">
              ${detail.photoSpots.map(spot => `<div class="spot-item">ğŸ“· ${esc(spot)}</div>`).join('')}
            </div>
          </div>
          
          <div class="modal-section">
            <div class="section-title">ğŸ’¡ ë°©ë¬¸ íŒ</div>
            <div class="visit-info-grid">
              <div class="visit-info-item">
                <div class="visit-label">ìš´ì˜ì‹œê°„</div>
                <div class="visit-value">${esc(p.hours)}</div>
              </div>
              <div class="visit-info-item">
                <div class="visit-label">ì…ì¥ë£Œ</div>
                <div class="visit-value">${esc(p.price)}</div>
              </div>
              <div class="visit-info-item">
                <div class="visit-label">ì†Œìš”ì‹œê°„</div>
                <div class="visit-value">${esc(detail.duration)}</div>
              </div>
            </div>
            <div class="tip-box">ğŸ’¡ ${esc(detail.tips)}</div>
          </div>
          
          ${nearbyFoods.length > 0 ? `
          <div class="modal-section">
            <div class="section-title">ğŸ½ï¸ ì£¼ë³€ ë§›ì§‘</div>
            <div class="nearby-note">${esc(detail.nearbyNote || '')}</div>
            <div class="nearby-foods-list">
              ${nearbyFoods.slice(0, 2).map(f => `
                <div class="nearby-food-item" onclick="closeModal();goToFood('${esc(f.name)}')">
                  <span class="food-name">${esc(f.name)}</span>
                  <span class="food-meta">â˜… ${f.rating} ${f.price} â†’</span>
                </div>
              `).join('')}
            </div>
            <button class="btn-nearby-all" onclick="closeModal();goToNearbyFood('${p.name.replace(/'/g, "\\'")}')">
              ğŸ½ï¸ ê·¼ì²˜ ë§›ì§‘ ë³´ê¸°
            </button>
          </div>
          ` : ''}
          
          <div class="place-actions modal-actions">
            <button class="place-btn btn-map" onclick="openMap('${esc(p.searchName || p.name)}')">ğŸ“ ì§€ë„</button>
            <button class="place-btn btn-search" onclick="openSearch('${esc(p.searchName || p.name)}')">ğŸ” ê²€ìƒ‰</button>
            <button class="place-btn btn-review" onclick="openReview('${esc(p.searchName || p.name)}')">â­ ë¦¬ë·°</button>
            <button class="place-btn btn-kr" onclick="openKrReview('${esc(p.searchName || p.name)}')">ğŸ‡°ğŸ‡·</button>
            <button class="place-btn btn-save ${savedPlaces.has(p.name)?'saved':''}" onclick="toggleSave('${esc(p.name)}');updateModalSaveBtn('${esc(p.name)}')">
              ${savedPlaces.has(p.name)?'â˜…':'â˜†'}
            </button>
          </div>
        `;
      } else {
        // â•â•â• ê¸°ë³¸ ëª¨ë‹¬ (ë§›ì§‘ ë˜ëŠ” ìƒì„¸ì •ë³´ ì—†ëŠ” ê´€ê´‘ì§€) â•â•â•
        const showNearbyBtn = isLandmark && nearbyFoods.length > 0;
        modalHtml = `
          <div class="modal-name">${esc(p.name)}</div>
          <div class="place-badges" style="margin:8px 0">
            <span class="badge badge-rating">â˜… ${p.rating}</span>
            <span class="badge badge-price">${p.price}</span>
            <span class="badge badge-hours">${p.hours}</span>
            <span class="badge badge-type">${TYPE_LABELS[p.type]}</span>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“ ${esc(p.address)}</div>
          <div style="font-size:13px;line-height:1.6;margin-bottom:12px">${esc(p.description)}</div>
          ${showNearbyBtn ? `
            <button class="place-btn" style="width:100%;margin-bottom:10px;background:rgba(46,196,160,.15);border:1px solid rgba(46,196,160,.3);color:var(--teal);" 
                    onclick="closeModal();goToNearbyFood('${p.name.replace(/'/g, "\\'")}')">
              ğŸ½ï¸ ê·¼ì²˜ ë§›ì§‘ ë³´ê¸°
            </button>
          ` : ''}
          <div class="place-actions">
            <button class="place-btn btn-map" onclick="openMap('${esc(p.searchName || p.name)}')">ğŸ“ ì§€ë„</button>
            <button class="place-btn btn-search" onclick="openSearch('${esc(p.searchName || p.name)}')">ğŸ” ê²€ìƒ‰</button>
            <button class="place-btn btn-review" onclick="openReview('${esc(p.searchName || p.name)}')">â­ ë¦¬ë·°</button>
            <button class="place-btn btn-kr" onclick="openKrReview('${esc(p.searchName || p.name)}')">ğŸ‡°ğŸ‡·</button>
            <button class="place-btn btn-save ${savedPlaces.has(p.name)?'saved':''}" onclick="toggleSave('${esc(p.name)}');closeModal()">
              ${savedPlaces.has(p.name)?'â˜…':'â˜†'}
            </button>
          </div>
        `;
      }
      
      document.getElementById('modalContent').innerHTML = modalHtml;
      document.getElementById('placeModal').classList.add('open');
    }

    // ê·¼ì²˜ ë§›ì§‘ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    function getNearbyFoodsList(landmarkName) {
      const result = [];
      const lmCoords = PLACE_COORDS[landmarkName];
      if (!lmCoords) return result;
      
      const foodTypes = ['cafe', 'dessert', 'seafood', 'restaurant', 'budget'];
      const foods = PLACES.filter(p => foodTypes.includes(p.type));
      
      foods.forEach(food => {
        const coords = PLACE_COORDS[food.name];
        if (!coords) return;
        const dist = getDistance(lmCoords.lat, lmCoords.lng, coords.lat, coords.lng);
        if (dist <= 500) { // ëª¨ë‹¬ ë¦¬ìŠ¤íŠ¸ë„ 300m -> 500më¡œ í™•ì¥
          result.push({ ...food, distance: dist });
        }
      });
      
      result.sort((a, b) => a.distance - b.distance);
      return result;
    }

    // íŠ¹ì • ë§›ì§‘ìœ¼ë¡œ ì´ë™
    function goToFood(foodName) {
      currentTab = 'food';
      selectedDay = 'all';
      selectedType = 'all';
      currentNearbyLandmark = null;
      foodSearchQuery = foodName;
      document.getElementById('foodSearch').value = foodName;
      renderTabs();
      renderFood();
    }

    // ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateModalSaveBtn(name) {
      const btn = document.querySelector('.modal-actions .btn-save');
      if (btn) {
        btn.classList.toggle('saved', savedPlaces.has(name));
        btn.innerHTML = savedPlaces.has(name) ? 'â˜…' : 'â˜†';
      }
    }

    function closeModal() {
      document.getElementById('placeModal').classList.remove('open');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LANDMARK TAG POPUP & FILTER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openTagPopup(landmarkName) {
      currentTagLandmark = landmarkName;
      document.getElementById('tagPopupName').textContent = landmarkName;
      document.getElementById('tagPopupOverlay').classList.add('open');
    }

    function closeTagPopup() {
      document.getElementById('tagPopupOverlay').classList.remove('open');
      currentTagLandmark = null;
    }

    function filterByLandmark() {
      const name = currentTagLandmark;
      selectedNearbyLandmark = name;
      document.getElementById('landmarkFilterName').textContent = name;
      document.getElementById('landmarkFilterBar').classList.add('active');
      closeTagPopup();
      renderFood();
      showToast(`ğŸ“ ${name} ê·¼ì²˜ ë§›ì§‘`);
    }

    function clearLandmarkFilter() {
      selectedNearbyLandmark = null;
      document.getElementById('landmarkFilterBar').classList.remove('active');
      renderFood();
    }

    function openLandmarkMap() {
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentTagLandmark + ' Lisboa Portugal')}`, '_blank');
      closeTagPopup();
    }

    function openLandmarkGuide() {
      closeTagPopup();
      if (typeof PLACE_GUIDES !== 'undefined' && PLACE_GUIDES[currentTagLandmark]) {
        openGuide(currentTagLandmark);
      } else {
        showToast('â„¹ï¸ ì¥ì†Œ ì •ë³´ ì¤€ë¹„ ì¤‘');
      }
    }

    // ë™ì„ /í•´ì„¤ì—ì„œ ê·¼ì²˜ ë§›ì§‘ ë³´ê¸°
    function goToNearbyFood(landmarkName) {
      closeGuide();
      closeModal();
      selectedNearbyLandmark = landmarkName;
      
      // GPS ê¸°ë°˜ 500m ë‚´ ë§›ì§‘ í™•ì¸
      const hasGPS = typeof PLACE_COORDS !== 'undefined' && PLACE_COORDS[landmarkName];
      const gpsNearby = hasGPS ? getNearbyFoodsByGPS(landmarkName, 500) : [];
      const useGPS = gpsNearby.length > 0;
      
      // í•„í„° í…ìŠ¤íŠ¸ ì„¤ì •
      const filterText = useGPS ? `${landmarkName} (500m ì´ë‚´)` : `${landmarkName} ê·¼ì²˜`;
      
      document.getElementById('landmarkFilterName').textContent = filterText;
      document.getElementById('landmarkFilterBar').classList.add('active');
      switchTab('food');
      renderFood();
      
      // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
      if (useGPS) {
        showToast(`ğŸ½ï¸ ${landmarkName} 500m ì´ë‚´ ${gpsNearby.length}ê³³`);
      } else {
        const mapping = getLandmarkToFoods();
        const fallbackCount = (mapping[landmarkName] || []).length;
        showToast(`ğŸ½ï¸ ${landmarkName} ê·¼ì²˜ ${fallbackCount}ê³³`);
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function esc(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SETTINGS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleSettings() {
      const panel = document.getElementById('settingsPanel');
      const btn = document.getElementById('settingsBtn');
      const isOpen = panel.classList.contains('open');
      if (!isOpen) {
        refreshApiStatus();
        switchProvider(currentProvider, false);
        document.getElementById('apiKeyInput').value = localStorage.getItem('pt_api_key') ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
        document.getElementById('apiKeyInputGoogle').value = localStorage.getItem('pt_api_key_google') ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
        document.getElementById('apiKeyInputAnthropic').value = localStorage.getItem('pt_api_key_anthropic') ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
        refreshModelSelection();
      }
      panel.classList.toggle('open', !isOpen);
      btn.classList.toggle('active', !isOpen);
    }

    function switchProvider(provider, save=true) {
      currentProvider = provider;
      if(save) localStorage.setItem('pt_provider', provider);
      document.getElementById('section-openrouter').style.display = provider === 'openrouter' ? 'block' : 'none';
      document.getElementById('section-google').style.display = provider === 'google' ? 'block' : 'none';
      document.getElementById('section-anthropic').style.display = provider === 'anthropic' ? 'block' : 'none';
      document.getElementById('tab-openrouter').classList.toggle('active', provider === 'openrouter');
      document.getElementById('tab-google').classList.toggle('active', provider === 'google');
      document.getElementById('tab-anthropic').classList.toggle('active', provider === 'anthropic');
      refreshApiStatus();
    }

    function selectModel(modelId, el) {
      currentModel = modelId;
      localStorage.setItem('pt_model', modelId);
      el.closest('.model-list').querySelectorAll('.model-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
    }

    function refreshModelSelection() {
      document.querySelectorAll('.model-option').forEach(el => {
        const onclick = el.getAttribute('onclick') || '';
        const match = onclick.match(/'([^']+)'/);
        if (match && match[1] === currentModel) el.classList.add('selected');
        else el.classList.remove('selected');
      });
    }

    function refreshApiStatus() {
      let key = '';
      if (currentProvider === 'google') key = localStorage.getItem('pt_api_key_google') || '';
      else if (currentProvider === 'anthropic') key = localStorage.getItem('pt_api_key_anthropic') || '';
      else key = localStorage.getItem('pt_api_key') || '';
      const el = document.getElementById('apiStatus');
      if (key) {
        const label = currentProvider === 'google' ? 'ğŸ†“ Google AI (ì™„ì „ë¬´ë£Œ)' : currentProvider === 'openrouter' ? 'ğŸ”€ OpenRouter' : 'ğŸ¤– Claude';
        el.innerHTML = '<div class="settings-status status-ok">âœ… ì—°ê²°ë¨ Â· ' + label + ' Â· AI ì‚¬ìš© ê°€ëŠ¥</div>';
      } else {
        el.innerHTML = '<div class="settings-status status-none">âš ï¸ API í‚¤ ì—†ìŒ Â· ì•„ë˜ì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”</div>';
      }
    }

    function saveApiKey() {
      const inputMap = { openrouter: 'apiKeyInput', google: 'apiKeyInputGoogle', anthropic: 'apiKeyInputAnthropic' };
      const storageMap = { openrouter: 'pt_api_key', google: 'pt_api_key_google', anthropic: 'pt_api_key_anthropic' };
      const val = document.getElementById(inputMap[currentProvider]).value.trim();
      if (val && val !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
        localStorage.setItem(storageMap[currentProvider], val);
      }
      localStorage.setItem('pt_provider', currentProvider);
      localStorage.setItem('pt_model', currentModel);
      const isGoogle = currentProvider === 'google';
      showToast(isGoogle ? 'âœ… ì €ì¥ë¨! Google AI ë¬´ë£Œë¡œ ì‚¬ìš©í•´ìš” ğŸ‰' : 'âœ… API í‚¤ ì €ì¥ ì™„ë£Œ!');
      refreshApiStatus();
      const btn = document.getElementById('settingsBtn');
      btn.style.borderColor = 'var(--green)';
      btn.style.color = 'var(--green)';
      document.getElementById('settingsPanel').classList.remove('open');
      document.getElementById('settingsBtn').classList.remove('active');
    }

    function clearApiKey() {
      ['pt_api_key','pt_api_key_google','pt_api_key_anthropic','pt_model','pt_provider'].forEach(k => localStorage.removeItem(k));
      localStorage.setItem('pt_model', 'gemini-2.0-flash');
      localStorage.setItem('pt_provider', 'google');
      document.getElementById('apiKeyInput').value = '';
      document.getElementById('apiKeyInputGoogle').value = '';
      document.getElementById('apiKeyInputAnthropic').value = '';
      currentProvider = 'google';
      currentModel = 'gemini-2.0-flash';
      switchProvider('google', false);
      refreshApiStatus();
      showToast('ì„¤ì • ì´ˆê¸°í™”ë¨');
      document.getElementById('settingsBtn').style.borderColor = '';
      document.getElementById('settingsBtn').style.color = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI AGENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleAI() {
      aiOpen = !aiOpen;
      document.getElementById('aiPanel').classList.toggle('open', aiOpen);
      if (aiOpen) setTimeout(() => document.getElementById('aiInput').focus(), 400);
    }

    function askSuggestion(text) {
      document.getElementById('aiInput').value = text;
      sendAI();
    }

    async function sendAI() {
      const input = document.getElementById('aiInput');
      const msg = input.value.trim();
      if (!msg || isAILoading) return;

      // ì œê³µì ë° í‚¤ ê²°ì •
      const provider = localStorage.getItem('pt_provider') || 'google';
      const storageMap = { openrouter: 'pt_api_key', google: 'pt_api_key_google', anthropic: 'pt_api_key_anthropic' };
      const apiKey = localStorage.getItem(storageMap[provider] || 'pt_api_key_google') || '';
      // ì €ì¥ëœ ëª¨ë¸ ì‚¬ìš©. êµ¬ë²„ì „ ëª¨ë¸ëª… ê°ì§€ ì‹œ ì•ˆì „í•œ ê¸°ë³¸ê°’ìœ¼ë¡œ êµì²´
      const SAFE_MODELS = ['gemini-2.0-flash','gemini-2.0-flash-lite','openrouter/free','meta-llama/llama-4-scout:free','qwen/qwen3-235b-a22b:free','moonshotai/kimi-vl-a3b-thinking:free','nousresearch/deephermes-3-llama-3-8b-preview:free','claude-sonnet-4-20250514','claude-haiku-4-5-20251001'];
      const rawModel = localStorage.getItem('pt_model') || '';
      const model = SAFE_MODELS.includes(rawModel) ? rawModel : 'gemini-2.0-flash';
      if (!SAFE_MODELS.includes(rawModel)) localStorage.setItem('pt_model', 'gemini-2.0-flash');

      if (!apiKey) {
        toggleSettings();
        return;
      }

      input.value = '';
      isAILoading = true;
      document.getElementById('aiSend').disabled = true;
      addMsg(msg, 'user');
      const loadingEl = addMsg('â³ ë¶„ì„ ì¤‘...', 'ai loading');
      scrollAI();

      // ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ
      const dayContext = APP_DATA.foodByDay.map(d =>
        d.dayNum + '(' + d.title + '): ' +
        d.categories.map(c => c.places.slice(0,3).map(p => p.name + '(â˜…' + p.rating + ')').join(',')).join(' | ')
      ).join('\n');

      const itinContext = APP_DATA.itinerary.slice(0,5).map(d =>
        d.dayLabel + ' ' + d.title + ': ' + d.schedule.slice(0,4).map(s => s.activity).join(', ')
      ).join('\n');

      const systemPrompt = 'ë‹¹ì‹ ì€ í¬ë¥´íˆ¬ê°ˆ ì—¬í–‰ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. 2026ë…„ 5ì›” 1-10ì¼ í¬ë¥´íˆ¬ê°ˆ ì—¬í–‰ì„ ë„ì™€ì¤ë‹ˆë‹¤.\n\n[ë§›ì§‘ DB]\n' + dayContext + '\n\n[ì¼ì •]\n' + itinContext + '\n\nê·œì¹™: í•œêµ­ì–´, ì´ëª¨ì§€ ì‚¬ìš©, êµ¬ì²´ì  ì‹ë‹¹ëª…Â·í‰ì  ì–¸ê¸‰, 3-5ë¬¸ì¥ ê°„ê²°í•˜ê²Œ';

      try {
        let response, reply;

        if (provider === 'google') {
          // â”€â”€ Google AI Studio (Gemini) â”€â”€
          const geminiUrl = 'https://generativelanguage.googleapis.com/v1/models/' + model + ':generateContent?key=' + apiKey;
          response = await fetch(geminiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                { role: 'user', parts: [{ text: systemPrompt + '\n\nì‚¬ìš©ì ì§ˆë¬¸: ' + msg }] }
              ],
              generationConfig: { maxOutputTokens: 1000, temperature: 0.7 }
            })
          });
          if (!response.ok) {
            const err = await response.json().catch(()=>({}));
            const errDetail = err?.error?.message || err?.error?.status || ('HTTP ' + response.status);
            throw new Error(errDetail);
          }
          const data = await response.json();
          if (!data.candidates || data.candidates.length === 0) {
            const blockReason = data.promptFeedback?.blockReason || 'ì•Œ ìˆ˜ ì—†ìŒ';
            throw new Error('ì‘ë‹µ ì—†ìŒ (ì°¨ë‹¨ ì‚¬ìœ : ' + blockReason + ')');
          }
          reply = data.candidates[0]?.content?.parts?.[0]?.text || 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”.';

        } else if (provider === 'openrouter') {
          // â”€â”€ OpenRouter (OpenAI í˜¸í™˜ API) â”€â”€
          response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey,
              'HTTP-Referer': 'https://portugal-travel-app',
              'X-Title': 'Portugal Travel 2026'
            },
            body: JSON.stringify({
              model: model,
              max_tokens: 1000,
              messages: [
                {role: 'system', content: systemPrompt},
                {role: 'user', content: msg}
              ]
            })
          });
          const data = await response.json();
          if (!response.ok) {
            const errMsg = data?.error?.message || JSON.stringify(data?.error) || 'HTTP ' + response.status;
            throw new Error(errMsg);
          }
          console.log('OpenRouter response:', data);
          reply = data.choices?.[0]?.message?.content;
          if (!reply) {
            throw new Error('ë¹ˆ ì‘ë‹µ: ' + JSON.stringify(data).substring(0, 200));
          }

        } else {
          // â”€â”€ Anthropic Claude â”€â”€
          response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: model,
              max_tokens: 1000,
              system: systemPrompt,
              messages: [{role: 'user', content: msg}]
            })
          });
          if (!response.ok) {
            const err = await response.json().catch(()=>({}));
            throw new Error(err?.error?.message || 'HTTP ' + response.status);
          }
          const data = await response.json();
          reply = data.content?.[0]?.text || 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”.';
        }

        loadingEl.className = 'msg msg-ai';
        loadingEl.innerHTML = reply.replace(/\n/g, '<br>');
      } catch(e) {
        loadingEl.className = 'msg msg-ai';
        loadingEl.innerHTML = 'âš ï¸ ì˜¤ë¥˜: ' + e.message;
      }
      
      isAILoading = false;
      document.getElementById('aiSend').disabled = false;
      scrollAI();
    }

    function addMsg(text, type) {
      const el = document.createElement('div');
      el.className = `msg msg-${type.includes('ai') ? 'ai' : 'user'}${type.includes('loading')?' loading':''}`;
      el.textContent = text;
      document.getElementById('aiMessages').appendChild(el);
      return el;
    }

    function scrollAI() {
      const msgs = document.getElementById('aiMessages');
      setTimeout(() => msgs.scrollTop = msgs.scrollHeight, 50);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('DOMContentLoaded', function() {
      const hasKey = localStorage.getItem('pt_api_key') || localStorage.getItem('pt_api_key_google') || localStorage.getItem('pt_api_key_anthropic');
      if (hasKey) {
        const btn = document.getElementById('settingsBtn');
        if (btn) { btn.style.borderColor = 'var(--green)'; btn.style.color = 'var(--green)'; }
      }
    });
    init();

async function hardRefresh() {
  if (confirm('ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ìµœì‹  ë²„ì „ì„ ë°›ì•„ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    try {
      // Service Worker ë“±ë¡ í•´ì œ
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of registrations) {
          await registration.unregister();
        }
      }
      // ì €ì¥ëœ ìºì‹œ ë°ì´í„° ì‚­ì œ
      if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(key => caches.delete(key)));
      }
      // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
      window.location.reload();
    } catch (e) {
      console.error(e);
      window.location.reload();
    }
  }
}
    </script>
</body>
</html>